<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lesehan Macca | Premium System</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f1a;
            --card-bg: rgba(30, 41, 59, 0.4);
            --primary: #f59e0b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-green: #25D366;
            --accent-red: #ef4444;
            --danger-dark: #450a0a;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; transform: translateZ(0); }
        
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at top right, #1e293b, #0b0f1a);
            color: var(--text-main); margin: 0; display: flex; justify-content: center; min-height: 100vh;
            overscroll-behavior-y: contain;
        }

        .app-container { width: 100%; max-width: 420px; padding: 20px; }

        /* MODAL STYLE */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 10001; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: #1e293b; width: 90%; max-width: 380px; padding: 25px;
            border-radius: 24px; border: 1px solid var(--primary);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        #greeting-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(30, 41, 59, 0.98) 0%, rgba(11, 15, 26, 1) 100%);
            backdrop-filter: blur(30px);
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1); opacity: 1;
        }

        .greet-text {
            font-size: 2.2rem; font-weight: 900; color: var(--primary); text-align: center;
            padding: 0 40px; line-height: 1.3; animation: superPulse 2s ease-in-out infinite;
        }

        @keyframes superPulse {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        #toast-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 85%; pointer-events: none; }
        .toast {
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid var(--primary);
            padding: 18px 22px; border-radius: 24px; margin-bottom: 12px; display: flex; align-items: center; gap: 14px;
            animation: toastIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast-icon { font-size: 1.5rem; }
        .toast-msg { font-size: 0.9rem; font-weight: 700; color: #fff; line-height: 1.4; }

        .waiting-icon { display: inline-block; animation: rotateWait 2s linear infinite; margin-right: 5px; }
        @keyframes rotateWait { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .empty-state {
            text-align: center; padding: 60px 20px; color: var(--text-dim); animation: slideUp 0.8s ease;
        }
        .empty-icon { font-size: 3rem; margin-bottom: 15px; display: block; filter: grayscale(1); opacity: 0.5; }

        .hidden { display: none !important; }
        .login-screen { text-align: center; padding-top: 40px; }
        .role-selector { display: flex; gap: 12px; justify-content: center; margin-bottom: 30px; }
        .btn-role {
            flex: 1; padding: 20px; border-radius: 20px; border: none; font-weight: 800; cursor: pointer;
            transition: 0.3s; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .btn-admin { background: var(--primary); color: #000; }
        .btn-driver { background: #10b981; color: #000; }
        
        .pin-display {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px; font-size: 1.8rem; letter-spacing: 8px;
            color: var(--primary); font-weight: 800; margin-bottom: 20px; min-height: 65px;
            display: flex; align-items: center; justify-content: center;
        }

        .num-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; justify-items: center; max-width: 280px; margin: 0 auto; }
        .num-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white;
            width: 65px; height: 65px; border-radius: 50%; font-size: 1.4rem; font-weight: 800; cursor: pointer;
        }
        .num-btn:active { background: var(--primary); color: black; }

        .nav-bar { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; background: rgba(255,255,255,0.03); 
            padding: 6px; border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--glass-border);
        }
        .nav-btn { padding: 14px; border: none; background: none; color: var(--text-dim); font-weight: 800; font-size: 11px; cursor: pointer; }
        .nav-btn.active { background: var(--primary); color: var(--bg); border-radius: 16px; }

        .order-card { 
            background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 24px; padding: 20px; 
            margin-bottom: 16px; border: 1px solid var(--glass-border); animation: slideUp 0.6s ease both; position: relative;
        }
        .cust-name { font-size: 1.2rem; font-weight: 800; display: block; margin-top: 4px; color: var(--text-main); width: 75%; }
        .cust-address { font-size: 0.9rem; font-weight: 600; color: var(--accent-blue); display: block; margin-top: 4px; width: 80%; line-height: 1.3; }
        .status-tag { font-size: 9px; font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

        .wa-float {
            position: absolute; top: 15px; right: 15px; width: 45px; height: 45px;
            background: var(--accent-green); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3); text-decoration: none;
        }

        .action-group { display: flex; gap: 8px; margin-top: 15px; }
        .action-btn { flex: 2; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .danger-btn-small { flex: 1; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; font-size: 10px; }
        .edit-btn-small { background: #64748b; color: white; flex: 1; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; font-size: 10px; }

        .history-date-sep { font-size: 11px; font-weight: 800; color: var(--primary); margin: 25px 0 15px 10px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
        .history-date-sep::after { content: ""; flex: 1; height: 1px; background: rgba(245, 158, 11, 0.2); }

        input { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); padding: 16px; border-radius: 16px; color: white; margin-bottom: 12px; font-size: 1rem; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastIn { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    </style>
</head>
<body onclick="enableAudioOnFirstClick()">

<div id="toast-container"></div>
<div id="greeting-overlay" class="hidden"><div id="greeting-content" class="greet-text"></div></div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--primary); margin-top:0;">Edit Orderan</h3>
        <input type="hidden" id="edit-id">
        <input type="text" id="edit-name" placeholder="Nama Pelanggan">
        <input type="text" id="edit-address" placeholder="Alamat">
        <input type="text" id="edit-wa" placeholder="WhatsApp">
        <div class="action-group">
            <button class="action-btn" style="background:var(--primary); color:#000" onclick="handleUpdateOrder()">SIMPAN</button>
            <button class="danger-btn-small" style="background:var(--accent-red); color:white" onclick="closeEditModal()">BATAL</button>
        </div>
    </div>
</div>

<div class="app-container">
    <div id="login-screen" class="login-screen">
        <div style="margin-bottom:40px;">
            <h1 style="color:var(--primary); font-size: 2.2rem; margin:0; letter-spacing: -2px; font-weight: 900;">MACCA</h1>
            <p style="color:var(--text-dim); font-weight: 700; font-size: 0.75rem; letter-spacing: 2px;">PREMIUM DELIVERY</p>
        </div>

        <div id="step-1">
            <div class="role-selector">
                <button class="btn-role btn-admin" onclick="handleRoleSelection('admin')"><span>ADMIN</span><small>DAPUR</small></button>
                <button class="btn-role btn-driver" onclick="handleRoleSelection('driver')"><span>DRIVER</span><small>PENGANTARAN</small></button>
            </div>
        </div>

        <div id="step-2" class="hidden">
            <p id="role-title" style="color:var(--primary); font-weight: 800; margin-bottom: 10px; text-transform: uppercase;"></p>
            <div id="pin-view" class="pin-display"></div>
            <div class="num-grid">
                <button class="num-btn" onclick="handlePressNum('1')">1</button>
                <button class="num-btn" onclick="handlePressNum('2')">2</button>
                <button class="num-btn" onclick="handlePressNum('3')">3</button>
                <button class="num-btn" onclick="handlePressNum('4')">4</button>
                <button class="num-btn" onclick="handlePressNum('5')">5</button>
                <button class="num-btn" onclick="handlePressNum('6')">6</button>
                <button class="num-btn" onclick="handlePressNum('7')">7</button>
                <button class="num-btn" onclick="handlePressNum('8')">8</button>
                <button class="num-btn" onclick="handlePressNum('9')">9</button>
                <button class="num-btn" style="background:rgba(239, 68, 68, 0.15); color:#ef4444" onclick="handleClearPin()">CLR</button>
                <button class="num-btn" onclick="handlePressNum('0')">0</button>
                <button class="num-btn" style="background:var(--primary); color:black;" onclick="handleLoginSubmit()">OK</button>
            </div>
            <button onclick="handleResetLogin()" style="background:none; border:none; color:var(--text-dim); margin-top:30px; font-weight:800; cursor:pointer;">KEMBALI KE MENU UTAMA</button>
        </div>
    </div>

    <div id="main-ui" class="hidden">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="background:rgba(255,255,255,0.05); padding:6px 16px; border-radius:50px; border:1px solid var(--primary); color:var(--primary); font-weight:800; font-size:0.75rem;" id="user-display">User</div>
            <div onclick="handleLogout()" style="color:var(--text-dim); cursor:pointer; font-size:10px; font-weight:800;">LOGOUT</div>
        </header>

        <nav class="nav-bar">
            <button id="tab-order" class="nav-btn active" onclick="handleSwitchTab('order')">ORDERS</button>
            <button id="tab-rank" class="nav-btn" onclick="handleSwitchTab('rank')">RANKING</button>
            <button id="tab-rekap" class="nav-btn" onclick="handleSwitchTab('rekap')">HISTORY</button>
        </nav>

        <section id="order-section">
            <div id="admin-only-form" class="hidden" style="margin-bottom: 25px;">
                <input type="text" id="cust-name" placeholder="Nama Pelanggan">
                <input type="text" id="cust-address" placeholder="Alamat Pengiriman">
                <input type="text" id="cust-wa" placeholder="WhatsApp (Contoh: 0812...)">
                <button class="action-btn" style="background:var(--primary); color:#000; width: 100%;" onclick="handleCreateOrder()">KIRIM KE DAPUR</button>
            </div>
            <div id="list-orders"></div>
        </section>

        <section id="rank-section" class="hidden"><div id="leaderboard"></div></section>
        <section id="rekap-section" class="hidden"><div id="history-list"></div></section>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, updateDoc, doc, serverTimestamp, setDoc, getDoc, limit, deleteDoc, increment, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWl_NXUXwt29rLArj79j8RlM8bY6kOCCg",
        authDomain: "delivery-macca-new.firebaseapp.com",
        projectId: "delivery-macca-new",
        storageBucket: "delivery-macca-new.firebasestorage.app",
        messagingSenderId: "544568459586",
        appId: "1:544568459586:web:9e4db30e700941ce4948db"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch(() => {});

    const USERS_DB = {
        '100': { name: 'SUPERADMIN', role: 'admin' },
        '8': { name: 'MANDA', role: 'admin' }, '9': { name: 'NUNU', role: 'admin' },
        '3': { name: 'ARA', role: 'admin' }, '4': { name: 'DILLA', role: 'admin' },
        '11': { name: 'HASBI', role: 'driver' }, '22': { name: 'REZKY', role: 'driver' }, '33': { name: 'ASWAR', role: 'driver' } 
    };

    let selectedRoleType = '';
    let currentPinInput = '';
    let knownOrders = new Set();
    const notifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    window.enableAudioOnFirstClick = () => {
        notifSound.play().then(() => { notifSound.pause(); notifSound.currentTime = 0; }).catch(() => {});
    };

    window.showToast = (msg, icon = '‚ú®') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-msg">${msg}</div>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, -20px)';
            toast.style.transition = '0.5s';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    };

    function triggerNewOrderAlert(customer) {
        notifSound.currentTime = 0;
        notifSound.play().catch(() => {});
        if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 800]);
        window.showToast(`ORDERAN BARU: ${customer}`, "üõµ");
    }

    window.handleRoleSelection = (role) => {
        selectedRoleType = role; currentPinInput = '';
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        document.getElementById('role-title').innerText = "PIN " + role;
    };

    window.handleResetLogin = () => { document.getElementById('step-2').classList.add('hidden'); document.getElementById('step-1').classList.remove('hidden'); };
    window.handleClearPin = () => { currentPinInput = ''; document.getElementById('pin-view').innerText = ''; };
    window.handlePressNum = (num) => { 
        window.enableAudioOnFirstClick();
        if (currentPinInput.length < 4) { currentPinInput += num; document.getElementById('pin-view').innerText = '*'.repeat(currentPinInput.length); } 
    };

    window.handleLoginSubmit = () => {
        const user = USERS_DB[currentPinInput];
        if (user && user.role === selectedRoleType) {
            localStorage.setItem('macca_user', JSON.stringify(user));
            localStorage.setItem('just_logged_in', 'true');
            location.reload();
        } else { window.showToast("PIN Salah!", "‚ùå"); window.handleClearPin(); }
    };

    window.handleLogout = () => { localStorage.clear(); location.reload(); };
    window.handleSwitchTab = (t) => {
        document.getElementById('order-section').classList.toggle('hidden', t!=='order');
        document.getElementById('rank-section').classList.toggle('hidden', t!=='rank');
        document.getElementById('rekap-section').classList.toggle('hidden', t!=='rekap');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
    };

    const currentUser = JSON.parse(localStorage.getItem('macca_user'));

    if (currentUser) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-ui').classList.remove('hidden');
        document.getElementById('user-display').innerText = currentUser.name;
        if (currentUser.role === 'admin') document.getElementById('admin-only-form').classList.remove('hidden');

        if (localStorage.getItem('just_logged_in')) {
            const overlay = document.getElementById('greeting-overlay');
            const content = document.getElementById('greeting-content');
            overlay.classList.remove('hidden');
            if(currentUser.name === 'SUPERADMIN') { content.innerHTML = `Selamat Datang<br><span style="color:#fff; font-size:2.8rem;">BOSS BESAR! üëë</span>`; } 
            else { content.innerHTML = currentUser.role === 'admin' ? `Assalamualaikum<br><span style="color:#fff; font-size:2.8rem;">Gadis-Gadis..!!!</span>` : `Selamat Bekerja<br><span style="color:#fff; font-size:2.8rem;">Bro..!!! üõµ</span>`; }
            setTimeout(() => { overlay.style.opacity = '0'; setTimeout(() => overlay.classList.add('hidden'), 1000); localStorage.removeItem('just_logged_in'); }, 3000);
        }

        window.openEditModal = async (id) => {
            const d = await getDoc(doc(db, "orders", id));
            if(d.exists()) {
                const data = d.data();
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-name').value = data.customer;
                document.getElementById('edit-address').value = data.address;
                document.getElementById('edit-wa').value = data.wa;
                document.getElementById('edit-modal').classList.add('active');
            }
        };

        window.closeEditModal = () => { document.getElementById('edit-modal').classList.remove('active'); };

        window.handleUpdateOrder = async () => {
            const id = document.getElementById('edit-id').value;
            const n = document.getElementById('edit-name').value;
            const a = document.getElementById('edit-address').value;
            const w = document.getElementById('edit-wa').value;
            if(n && a && w) {
                await updateDoc(doc(db, "orders", id), { customer: n, address: a, wa: w });
                window.showToast("Data Berhasil Diperbaiki!", "‚úÖ");
                window.closeEditModal();
            }
        };

        const startListening = () => {
            onSnapshot(query(collection(db, "orders"), where("status", "!=", "SELESAI")), (snap) => {
                const list = document.getElementById('list-orders');
                
                // NOTIFICATION LOGIC
                snap.docChanges().forEach(change => {
                    const data = change.doc.data();
                    if (currentUser.role === 'driver' && data.status === "SIAP" && !knownOrders.has(change.doc.id)) {
                        triggerNewOrderAlert(data.customer);
                        knownOrders.add(change.doc.id);
                    }
                });

                // EMPTY STATE LOGIC (Pembeda Admin & Driver)
                if (snap.empty) { 
                    if (currentUser.role === 'admin') {
                        list.innerHTML = `
                            <div class="empty-state">
                                <span class="empty-icon">üç≥</span>
                                <div style="font-weight:800; font-size:1.1rem; color:var(--primary);">DAPUR STANDBY</div>
                                <div style="font-size:0.8rem; margin-top:5px;">Belum ada pesanan yang masuk.</div>
                            </div>`;
                    } else {
                        list.innerHTML = `
                            <div class="empty-state">
                                <span class="empty-icon">üõµ</span>
                                <div class="waiting-icon" style="font-size:1.5rem; margin-bottom:10px;">‚è≥</div>
                                <div style="font-weight:800; font-size:1.1rem; color:var(--accent-green);">SANTAY DULU..</div>
                                <div style="font-size:0.8rem; margin-top:5px;">Belum ada orderan siap antar.</div>
                            </div>`;
                    }
                    return; 
                }
                
                list.innerHTML = "";
                snap.docs.sort((a,b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0)).forEach(d => {
                    const item = d.data();
                    const cleanWA = item.wa ? item.wa.replace(/\D/g, '').replace(/^0/, '62') : '';
                    let action = "";
                    
                    if (currentUser.role === 'admin') {
                        let statusUI = (item.status === 'DAPUR') ? `<button class="action-btn" style="background:var(--accent-blue);color:#000" onclick="window.updateStatus('${d.id}', 'SIAP')">SIAP DIANTAR</button>` :
                                       (item.status === 'SIAP') ? `<div style="flex:2; color:var(--accent-blue); text-align:center; font-weight:800; font-size:10px;"><span class="waiting-icon">‚è≥</span>TUNGGU DRIVER</div>` :
                                       `<div style="flex:2; color:var(--accent-green);text-align:center;font-weight:800;font-size:11px">üõµ ${item.driver} OTW</div>`;
                        action = `<div class="action-group">${statusUI}<button class="edit-btn-small" onclick="window.openEditModal('${d.id}')">‚úèÔ∏è</button><button class="danger-btn-small" style="background:var(--accent-red); color:white;" onclick="window.deleteOrder('${d.id}')">üóëÔ∏è</button></div>`;
                    } else {
                        if (item.status === 'SIAP') { action = `<button class="action-btn" style="background:#10b981;color:#000;width:100%;margin-top:15px;" onclick="window.takeOrder('${d.id}')">SAYA JEMPUT</button>`; }
                        else if (item.status === 'DIANTAR' && item.driver === currentUser.name) {
                            action = `<div class="action-group"><button class="action-btn" style="background:var(--primary);color:#000" onclick="window.finishOrder('${d.id}')">SAMPAI!</button><button class="danger-btn-small" style="background:var(--danger-dark); color:#ef4444; border: 1px solid #ef4444;" onclick="window.cancelTake('${d.id}')">BATAL</button></div>`;
                        } else if (item.status === 'DIANTAR') { action = `<div style="color:var(--accent-green);text-align:center;margin-top:15px;font-weight:800;font-size:11px">üõµ ${item.driver} OTW</div>`; }
                        else { action = `<div style="text-align:center; color:var(--text-dim); font-size:10px; font-weight:800; margin-top:15px;"><span class="waiting-icon">üë©‚Äçüç≥</span> LAGI DIMASAK</div>`; }
                    }

                    list.innerHTML += `<div class="order-card">
                        <span class="status-tag">${item.status}</span>
                        <span class="cust-name">${item.customer}</span>
                        <span class="cust-address">üìç ${item.address}</span>
                        <a href="https://wa.me/${cleanWA}" target="_blank" class="wa-float"><svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12.031 6.172c-2.32 0-4.591 1.342-4.591 4.225 0 1.002.392 1.777.896 2.454l-1.025 2.158 2.223-.748c.636.353 1.353.567 2.112.567 2.721 0 4.809-1.921 4.809-4.432 0-2.457-1.996-4.224-4.524-4.224zm0-1.172c3.21 0 5.696 2.379 5.696 5.396 0 3.125-2.618 5.604-5.811 5.604-.882 0-1.716-.192-2.464-.533l-3.452 1.163 1.597-3.36c-.636-.856-1.007-1.921-1.007-3.094.001-3.149 2.508-5.176 5.441-5.176zm8.115 11.232c-.392 1.254-2.146 2.115-3.232 2.193-1.086.078-2.215-.246-4.636-1.215-3.344-1.344-5.462-4.739-5.636-4.97-.174-.23-.974-1.284-.974-2.45 0-1.166.608-1.738.826-1.972.218-.234.478-.292.637-.292.159 0 .319.001.458.007.146.007.342-.055.536.411.194.466.666 1.623.724 1.739.058.116.097.252.02.406-.078.154-.117.251-.232.385-.116.134-.244.298-.348.4-.116.116-.237.242-.102.473.134.23.595.981 1.282 1.594.883.787 1.626 1.03 1.861 1.146.235.116.372.097.51-.058.138-.155.592-.687.749-.92.158-.233.316-.194.534-.116.218.078 1.383.652 1.621.77.237.117.396.175.454.272.058.097.058.563-.153 1.188z"/></svg></a>
                        <div style="font-size: 8px; color: var(--text-dim); margin-top:10px;">Dibuat: ${item.adminOnDuty}</div>
                        ${action}
                    </div>`;
                });
            });
        };

        startListening();

        onSnapshot(collection(db, "driver_stats"), (snap) => {
            const lb = document.getElementById('leaderboard'); lb.innerHTML = "";
            const drivers = []; snap.forEach(d => drivers.push({id: d.id, ...d.data()}));
            drivers.sort((a,b) => (b.points || 0) - (a.points || 0)).forEach((drv, idx) => {
                lb.innerHTML += `<div class="order-card" style="display:flex;align-items:center;padding:15px"><div style="font-size:20px;font-weight:900;color:var(--primary);width:35px;opacity:0.5">${idx+1}</div><div style="flex:1"><div style="font-weight:800;">${drv.id}</div><div style="color:var(--accent-green);font-size:14px;font-weight:900;">üõµ ${drv.totalOrders || 0} SELESAI</div></div><div style="text-align:right"><div style="color:var(--primary);font-weight:900;font-size:1.1rem">${drv.points || 0}</div><div style="font-size:9px;color:var(--text-dim);">POIN</div></div></div>`;
            });
        });

        const historyQuery = query(collection(db, "orders"), where("status", "==", "SELESAI"), limit(40));
        onSnapshot(historyQuery, (snap) => {
            const histList = document.getElementById('history-list');
            if (snap.empty) { histList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-dim)">Belum ada history.</div>`; return; }
            const sortedDocs = snap.docs.sort((a, b) => (b.data().finishedAt?.seconds || 0) - (a.data().finishedAt?.seconds || 0));
            histList.innerHTML = ""; let lastDate = "";
            sortedDocs.forEach(d => {
                const item = d.data();
                const ts = item.finishedAt || item.createdAt; if (!ts) return;
                const dateObj = new Date(ts.seconds * 1000);
                const dateStr = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                if (dateStr !== lastDate) { histList.innerHTML += `<div class="history-date-sep">${dateStr}</div>`; lastDate = dateStr; }
                histList.innerHTML += `<div class="order-card" style="opacity:0.9; padding: 18px; border-left: 4px solid var(--accent-green);"><span class="status-tag" style="color:var(--accent-green)">SELESAI</span><span class="cust-name">${item.customer}</span><span class="cust-address">üìç ${item.address}</span><div style="margin-top:10px; font-size:11px;">Kurir: ${item.driver}</div></div>`;
            });
        });

        window.handleCreateOrder = async () => {
            const n = document.getElementById('cust-name').value;
            const a = document.getElementById('cust-address').value;
            const w = document.getElementById('cust-wa').value;
            if(n && a && w) {
                await addDoc(collection(db, "orders"), { customer: n, address: a, wa: w, status: "DAPUR", adminOnDuty: currentUser.name, createdAt: serverTimestamp() });
                window.showToast("Berhasil!", "üë©‚Äçüç≥");
                document.getElementById('cust-name').value = ""; document.getElementById('cust-address').value = ""; document.getElementById('cust-wa').value = "";
            } else { window.showToast("Isi data!", "üò§"); }
        };

        window.updateStatus = async (id, status) => { await updateDoc(doc(db, "orders", id), { status: status }); };
        window.deleteOrder = async (id) => { if(confirm("Hapus?")) { await deleteDoc(doc(db, "orders", id)); window.showToast("Terhapus!", "üóëÔ∏è"); } };
        window.takeOrder = async (id) => { await updateDoc(doc(db, "orders", id), { status: "DIANTAR", driver: currentUser.name }); };
        window.cancelTake = async (id) => { if(confirm("Batal?")) { await updateDoc(doc(db, "orders", id), { status: "SIAP", driver: "" }); } };
        window.finishOrder = async (id) => {
            await updateDoc(doc(db, "orders", id), { status: "SELESAI", finishedAt: serverTimestamp() });
            const dr = doc(db, "driver_stats", currentUser.name);
            const ds = await getDoc(dr);
            if (ds.exists()) { await updateDoc(dr, { points: increment(500), totalOrders: increment(1) }); } else { await setDoc(dr, { points: 500, totalOrders: 1 }); }
        };
    }
</script>
</body>
</html>
